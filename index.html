<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sternenr√§tsel</title>
  <style>
    :root {
      --bg1: #070b1a;
      --bg2: #0c1533;
      --acc: #ffd44d;
      --muted: #9aa4c2;
      --good: #22c55e;
      --bad: #ef4444;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      color: #e8ecff;
      background: radial-gradient(1200px 600px at 70% 10%, var(--bg2), var(--bg1));
    }

    .app {
      display: grid;
      grid-template-rows:auto 1fr auto;
      min-height: 100%;
    }

    header {
      display: flex;
      gap: .75rem;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      backdrop-filter: blur(6px);
    }

    header h1 {
      font-size: 1.05rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: .2px
    }

    header .actions {
      display: flex;
      gap: .5rem;
      align-items: center
    }

    button {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, .15);
      background: rgba(255, 255, 255, .06);
      color: #fff;
      padding: .5rem .75rem;
      border-radius: .75rem;
      cursor: pointer;
      font-weight: 600
    }

    button:hover {
      background: rgba(255, 255, 255, .12)
    }

    button.primary {
      border-color: transparent;
      background: linear-gradient(180deg, #5b7cff, #2c5aff)
    }

    .wrap {
      display: grid;
      grid-template-columns:340px 1fr;
      gap: 1rem;
      min-height: 0
    }

    @media (max-width: 900px) {
      .wrap {
        grid-template-columns:1fr
      }
    }

    .panel {
      padding: 1rem 1.25rem
    }

    .card {
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25)
    }

    .muted {
      color: var(--muted)
    }

    /* Star canvas */
    #skyWrap {
      position: relative;
      overflow: hidden;
      aspect-ratio: 16/9;
      min-height: 320px;
    }

    #sky {
      width: 100%;
      height: 100%;
      display: block
    }

    .hint {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      cursor: crosshair
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      background: rgba(0, 0, 0, .5);
      border: 1px solid rgba(255, 255, 255, .15);
      padding: .6rem .9rem;
      border-radius: .75rem;
      font-size: .95rem
    }

    dialog {
      border: none;
      background: rgba(15, 22, 50, .9);
      color: #fff;
      border-radius: 1rem;
      max-width: 520px;
      width: calc(100% - 2rem);
      padding: 1.25rem 1.25rem 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .45);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .55)
    }

    .modal-header {
      display: flex;
      gap: .75rem;
      align-items: center;
      margin-bottom: .5rem
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .25rem .5rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .12);
      font-size: .8rem
    }

    .confetti {
      position: fixed;
      top: -20px;
      font-size: 22px;
      animation: fall 2.2s ease-in forwards
    }

    @keyframes fall {
      to {
        transform: translateY(105vh) rotate(540deg);
        opacity: .2
      }
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: .5rem;
      margin: .5rem 0 0
    }

    .list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .07);
      padding: .5rem .6rem;
      border-radius: .6rem
    }

    .tag {
      font-size: .8rem;
      color: #b9c2e6
    }

    .small {
      font-size: .85rem
    }

    input[type="text"] {
      width: 100%;
      padding: .55rem .65rem;
      border-radius: .6rem;
      border: 1px solid rgba(255, 255, 255, .15);
      background: rgba(255, 255, 255, .06);
      color: #fff
    }

    form {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-top: .5rem
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>‚≠ê Sternenr√§tsel</h1>
    <div class="actions">
      <button id="newPuzzle" class="primary">Neues R√§tsel</button>
      <button id="toggleHints">Hinweis an/aus</button>
    </div>
  </header>

  <div class="wrap">
    <section class="panel card" aria-label="Seitenleiste">
      <h2 style="margin:.25rem 0 .25rem">Anleitung</h2>
      <p class="muted small">Finde das Sternbild, indem du die richtigen Sterne der Reihe nach antippst. Gib danach den
        Namen ein (deutsch oder lateinisch). Als Belohnung erh√§ltst du eine √úberraschung. ü•≥</p>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:.75rem 0"/>


      <div>
        <div class="pill" title="Aktives R√§tsel"><span>üî≠</span><span id="activeName">‚Äì</span></div>
        <form id="answerForm" autocomplete="off">
          <input id="answer" type="text" placeholder="Name des Sternbilds ‚Ä¶" aria-label="Antwort"/>
          <button>Pr√ºfen</button>
        </form>
      </div>


      <h3 style="margin:1rem 0 .25rem">Gefundene Sternbilder</h3>
      <ul id="foundList" class="list" aria-live="polite"></ul>

      <h3 style="margin:1rem 0 .25rem">Verf√ºgbare R√§tsel</h3>
      <ul id="availableList" class="list"></ul>
    </section>

    <section id="skyWrap" class="panel card" aria-label="Sternenhimmel">
      <canvas id="sky" aria-label="Interaktiver Sternenhimmel"></canvas>
      <canvas id="overlay" class="hint" aria-hidden="true"></canvas>
    </section>
  </div>

  <footer class="panel" style="opacity:.9">
    <span
      class="muted small">Tipp: Langer Druck/Klick auf den Himmel erzeugt einen Screenshot (PNG) zum Verschenken.</span>
  </footer>
</div>

<dialog id="fortuneModal">
  <div class="modal-header">
    <div class="pill"><span>üçÄ</span> Gl√ºckskeks</div>
  </div>
  <p id="fortuneText" class="small" style="line-height:1.4"></p>
  <form method="dialog" style="margin-top:.75rem">
    <button autofocus>Weiter</button>
  </form>
</dialog>

<script>
  const FORTUNES = [
    "Du untersch√§tzt, wie stark du bist.",
    "Heute ist ein guter Tag, eine mutige Entscheidung zu treffen.",
    "Kleine Schritte ‚Äì gro√üe Wirkung.",
    "Dein L√§cheln ver√§ndert R√§ume.",
    "Du darfst stolz auf dich sein.",
    "Ein Kapitel endet, ein besseres beginnt.",
    "Vertrau auf deinen Kompass, nicht auf den Wind.",
    "Alles, was du brauchst, tr√§gst du bereits in dir.",
    "Dein Flei√ü macht T√ºren auf, die andere nicht sehen.",
    "Du bringst Licht in die Welt ‚Äì weiter so!",
  ];

  const CONSTELLATIONS = [
    {
      id: "ursa_minor",
      display: "Kleiner Wagen",
      aliases: ["kleiner wagen", "ursa minor", "kleine b√§rin", "little dipper", "kleiner b√§r"],
      points: [[0.52, 0.15], [0.48, 0.28], [0.46, 0.45], [0.48, 0.66], [0.53, 0.85], [0.48, 0.95], [0.44, 0.73]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 3]]
    },
    {
      id: "aries", display: "Widder", aliases: ["widder", "aries"],
      points: [[0.05, 0.20], [0.35, 0.28], [0.55, 0.42], [0.60, 0.63]],
      edges: [[0, 1], [1, 2], [2, 3]]
    },
    {
      id: "taurus", display: "Stier", aliases: ["stier", "taurus"],
      points: [[0.15, 0.1], [0.58, 0.52], [0.62, 0.56], [0.64, 0.60], [0.70, 0.63], [0.92, 0.64], [0.12, 0.48], [0.56, 0.63], [0.60, 0.62], [0.67, 0.1]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [6, 7], [7, 8], [8, 3], [9, 2]]
    },
    {
      id: "gemini", display: "Zwillinge", aliases: ["zwillinge", "gemini"],
      points: [[0.4, 0.1], [0.2, 0.4], [0.35, 0.6], [0.5, 0.63], [0.75, 0.9], [0.75, 0.45], [0.9, 0.65], [0.98, 0.65]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [7, 6], [6, 5], [5, 0]]
    },
    {
      id: "cancer", display: "Krebs", aliases: ["krebs", "cancer"],
      points: [[0.5, 0.1], [0.55, 0.4], [0.545, 0.55], [0.48, 0.78], [0.85, 0.9]],
      edges: [[0, 1], [1, 2], [2, 3], [4, 2]]
    },
    {
      id: "leo", display: "L√∂we", aliases: ["l√∂we", "leo"],
      points: [[0.96, 0.20], [0.91, 0.12], [0.8, 0.23], [0.79, 0.35], [0.85, 0.54], [0.88, 0.8], [0.45, 0.74], [0.15, 0.78], [0.45, 0.35]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 3]]
    },
    {
      id: "virgo", display: "Jungfrau", aliases: ["jungfrau", "virgo"],
      points: [[0.94, 0.35], [0.9, 0.5], [0.7, 0.56], [0.6, 0.57], [0.3, 0.72], [0.25, 0.85], [0.24, 0.55], [0.58, 0.2], [0.56, 0.35]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [6, 4], [7, 8], [8, 3]]
    },
    {
      id: "libra", display: "Waage", aliases: ["waage", "libra"],
      points: [[0.2, 0.7], [0.23, 0.6], [0.26, 0.5], [0.18, 0.23], [0.45, 0.25], [0.6, 0.5], [0.55, 0.8], [0.6, 0.85]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 3], [5, 6], [6, 7]]
    },
    {
      id: "scorpio", display: "Skorpion", aliases: ["skorpion", "scorpio"],
      points: [[0.24, 0.5], [0.18, 0.65], [0.3, 0.85], [0.4, 0.84], [0.5, 0.8], [0.51, 0.65], [0.5, 0.57], [0.55, 0.4], [0.56, 0.35], [0.6, 0.3], [0.64, 0.13], [0.72, 0.21], [0.75, 0.34]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 9], [9, 10], [9, 11], [9, 12]]
    },
    {
      id: "sagittarius", display: "Sch√ºtze", aliases: ["sch√ºtze", "sagittarius"],
      points: [[0.24, 0.2], [0.2, 0.23], [0.3, 0.4], [0.38, 0.44], [0.5, 0.35], [0.6, 0.5], [0.59, 0.65], [0.63, 0.75], [0.67, 0.49], [0.6, 0.15], [0.22, 0.5], [0.25, 0.55]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [8, 5], [9, 4], [11, 10], [10, 2]]
    },
    {
      id: "capricornus", display: "Steinbock", aliases: ["steinbock", "capricornus"],
      points: [[0.2, 0.75], [0.25, 0.76], [0.32, 0.8], [0.48, 0.79], [0.6, 0.78], [0.61, 0.75], [0.65, 0.3], [0.35, 0.6], [0.28, 0.65], [0.21, 0.74], [0.7, 0.2]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 9], [6, 10]]
    },
    {
      id: "aquarius", display: "Wassermann", aliases: ["wassermann", "aquarius"],
      points: [[0.65, 0.15], [0.45, 0.3], [0.35, 0.43], [0.48, 0.5], [0.6, 0.48], [0.36, 0.5], [0.34, 0.52], [0.335, 0.55], [0.5, 0.8], [0.55, 0.7], [0.6, 0.68], [0.62, 0.7], [0.68, 0.75]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [2, 5], [5, 6], [6, 7], [7, 8], [8, 9], [9, 10], [10, 11], [11, 12]]
    },
    {
      id: "pisces", display: "Fische", aliases: ["fische", "pisces"],
      points: [[0.2, 0.1], [0.19, 0.13], [0.205, 0.15], [0.24, 0.17], [0.28, 0.2], [0.275, 0.35], [0.28, 0.5], [0.28, 0.8], [0.3, 0.78], [0.32, 0.72], [0.35, 0.67], [0.44, 0.55], [0.48, 0.51], [0.6, 0.35], [0.65, 0.31], [0.68, 0.26], [0.71, 0.25], [0.74, 0.28], [0.73, 0.35], [0.69, 0.39]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 9], [9, 10], [10, 11], [11, 12], [12, 13], [13, 14], [14, 15], [15, 16], [16, 17], [17, 18], [18, 19], [19, 14]]
    },
    {
      id: "aquila", display: "Adler", aliases: ["adler", "aquila"],
      points: [[0.5, 0.1], [0.45, 0.2], [0.4, 0.25], [0.2, 0.6], [0.6, 0.65], [0.8, 0.1], [0.65, 0.85]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 1], [1, 4], [4, 6]]
    },
    {
      id: "bootes", display: "B√§renh√ºter", aliases: ["b√§renh√ºter", "bootes"],
      points: [[0.5, 0.1], [0.5, 0.2], [0.48, 0.33], [0.4, 0.3], [0.3, 0.4], [0.4, 0.65], [0.5, 0.85], [0.5, 0.6], [0.4, 0.95], [0.6, 0.87]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 2], [8, 6], [6, 9]]
    },
    {
      id: "auriga", display: "Fuhrmann", aliases: ["fuhrmann", "auriga"],
      points: [[0.9, 0.9], [0.4, 0.75], [0.1, 0.4], [0.09, 0.15], [0.45, 0.1], [0.6, 0.2], [0.63, 0.55]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 1]]
    },
    {
      id: "ursa_major", display: "Gro√üer B√§r", aliases: ["gro√üer b√§r", "ursa major"],
      points: [[0.1, 0.7], [0.12, 0.67], [0.4, 0.4], [0.48, 0.35], [0.53, 0.27], [0.54, 0.15], [0.57, 0.05], [0.55, 0.5], [0.7, 0.65], [0.9, 0.8], [0.83, 0.67], [0.65, 0.43], [0.64, 0.8], [0.62, 0.95], [0.66, 0.95], [0.38, 0.57], [0.36, 0.7], [0.4, 0.69]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [3, 7], [7, 8], [8, 9], [9, 10], [10, 11], [11, 4], [11, 7], [8, 12], [12, 13], [12, 14], [2, 15], [15, 16], [15, 17]]
    },
    {
      id: "canis_major", display: "Gro√üer Hund", aliases: ["gro√üer hund", "canis major"],
      points: [[0.6, 0.15], [0.45, 0.1], [0.4, 0.6], [0.37, 0.75], [0.23, 0.88], [0.51, 0.88], [0.6, 0.95]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [3, 5], [5, 6]]
    },
    {
      id: "ursa_major_2", display: "Gro√üer Wagen", aliases: ["gro√üer wagen", "ursa major"],
      points: [[0.5, 0.1], [0.52, 0.2], [0.5, 0.3], [0.49, 0.45], [0.35, 0.6], [0.4, 0.95], [0.55, 0.78]],
      edges: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6], [6, 3]]
    }
  ];

  const sky = document.getElementById('sky');
  const overlay = document.getElementById('overlay');
  const skyWrap = document.getElementById('skyWrap');
  const ctx = sky.getContext('2d');
  const octx = overlay.getContext('2d');


  function getDPR() {
    return Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  }

  function resize() {
    DPR = getDPR();
    stars = [];
    const rect = skyWrap.getBoundingClientRect();
    [sky, overlay].forEach(cv => {
      cv.width = Math.floor(rect.width * DPR);
      cv.height = Math.floor((rect.height) * DPR);
      cv.style.width = rect.width + "px";
      cv.style.height = rect.height + "px";
    });
    drawBackground();
    drawStars();
    drawProgress();
  }

  window.addEventListener('resize', resize);

  let stars = [];

  function randomStars(n) {
    const arr = [];
    const w = sky.width, h = sky.height;
    for (let i = 0; i < n; i++) {
      arr.push({
        x: Math.random() * w,
        y: Math.random() * h,
        r: (Math.random() * 1.2 + 0.4) * DPR,
        tw: Math.random() * Math.PI * 2
      });
    }
    return arr;
  }

  function drawBackground() {
    const g = ctx.createLinearGradient(0, 0, sky.width, sky.height);
    g.addColorStop(0, 'rgba(20,32,72,.9)');
    g.addColorStop(1, 'rgba(6,10,24,.95)');
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, sky.width, sky.height);
  }

  function drawStars() {
    if (!stars.length) stars = randomStars(220);
    for (const s of stars) {
      const twinkle = (Math.sin(Date.now() / 700 + s.tw) * 0.4 + 0.6);
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r * twinkle, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${0.6 + 0.4 * Math.random()})`;
      ctx.fill();
    }
  }

  const activeNameEl = document.getElementById('activeName');
  const foundList = document.getElementById('foundList');
  const availableList = document.getElementById('availableList');
  const answerForm = document.getElementById('answerForm');
  const answerInput = document.getElementById('answer');
  const btnNew = document.getElementById('newPuzzle');
  const btnHints = document.getElementById('toggleHints');
  const DEBUG = false;

  let showHints = DEBUG;
  let active = null;
  let edgeIdx = 0;
  let progress = [];
  let found = new Set(JSON.parse(localStorage.getItem('found-consts') || '[]'));
  let DPR = getDPR();
  let lastActiveId = localStorage.getItem('debug-active') || null;


  function saveFound() {
    localStorage.setItem('found-consts', JSON.stringify([...found]));
  }

  function drawProgress() {
    octx.clearRect(0, 0, overlay.width, overlay.height);
    if (!active) return;

    const edgeSet = new Set(
      active.edges.flatMap(([a, b]) => [`${a}-${b}`, `${b}-${a}`])
    );

    const w = overlay.width, h = overlay.height;
    const pts = active.points.map(([x, y]) => ({x: x * w, y: y * h}));

    if (showHints) {
      octx.strokeStyle = 'rgba(255,255,255,.15)';
      octx.lineWidth = 2 * DPR;
      octx.setLineDash([6 * DPR, 6 * DPR]);
      octx.beginPath();
      for (const [a, b] of active.edges) {
        octx.moveTo(pts[a].x, pts[a].y);
        octx.lineTo(pts[b].x, pts[b].y);
      }
      octx.stroke();
      octx.setLineDash([]);
    }

    octx.strokeStyle = 'rgba(255,212,77,.95)';
    octx.lineWidth = 3 * DPR;
    /* octx.beginPath();
     for (let i = 0; i < progress.length - 1; i++) {
       const a = pts[progress[i]], b = pts[progress[i + 1]];
       octx.moveTo(a.x, a.y);
       octx.lineTo(b.x, b.y);
     }
     octx.stroke();*/
    for (let i = 0; i < progress.length - 1; i++) {
      const aIdx = progress[i];
      const bIdx = progress[i + 1];
      if (!edgeSet.has(`${aIdx}-${bIdx}`)) continue;
      const a = pts[aIdx], b = pts[bIdx];
      octx.beginPath();
      octx.moveTo(a.x, a.y);
      octx.lineTo(b.x, b.y);
      octx.stroke();
    }

    for (let i = 0; i < pts.length; i++) {
      const p = pts[i];
      const isStart = (i === 0);
      const done = progress.includes(i);
      const shouldBeYellow = done || (isStart && progress.length === 0);

      octx.beginPath();
      octx.arc(p.x, p.y, 6 * DPR, 0, Math.PI * 2);
      octx.fillStyle = shouldBeYellow ? 'rgba(255, 212, 77, .95)' : 'rgba(255, 255, 255, .6)';
      octx.fill();
      octx.strokeStyle = 'rgba(0,0,0,.35)';
      octx.lineWidth = 1 * DPR;

    }
  }

  function getById(id) {
    return CONSTELLATIONS.find(c => c.id === id) || null;
  }

  function startPuzzle(c) {
    active = c;
    edgeIdx = 0;
    progress = [0];
    activeNameEl.textContent = DEBUG ? active.display : "???";
    if(DEBUG) {
      lastActiveId = c.id;
      localStorage.setItem('debug-active', c.id);
      showHints = true;
    }
    drawBackground();
    drawStars();
    drawProgress();
    answerInput.value = '';
  }

  function pickNew() {
    if (DEBUG && lastActiveId) {
      const same = getById(lastActiveId);
      if (same)
        return startPuzzle(same);
    }
    const pool = CONSTELLATIONS.filter(c => !found.has(c.id));
    const choice = pool.length ? pool[Math.floor(Math.random() * pool.length)] : CONSTELLATIONS[Math.floor(Math.random() * CONSTELLATIONS.length)];
    startPuzzle(choice);
    /*active = pool.length ? pool[Math.floor(Math.random() * pool.length)] : CONSTELLATIONS[Math.floor(Math.random() * CONSTELLATIONS.length)];
    edgeIdx = 0;
    progress = [0];
    activeNameEl.textContent = DEBUG ? active.display : "???";
    drawBackground();
    drawStars();
    drawProgress();
    answerInput.value = '';*/
  }

  function rebuildLists() {
    foundList.innerHTML = '';
    for (const c of CONSTELLATIONS) {
      if (found.has(c.id)) {
        const li = document.createElement('li');
        li.innerHTML = `<span>‚úÖ ${c.display}</span><span class="tag">gefunden</span>`;
        foundList.appendChild(li);
      }
    }

    const li = document.createElement('li');
    const resetBtn = document.createElement('button');
    resetBtn.textContent = 'Fortschritt zur√ºcksetzen';
    resetBtn.classList.add('primary');
    resetBtn.addEventListener('click', () => {
      if (!confirm('Gefundene Sternenbilder wirklich l√∂schen?')) return;
      found.clear();
      saveFound();
      rebuildLists();
      pickNew();
      toast('Fortschritt zur√ºckgesetzt.')
    });
    //resetBtn.addEventListener('click', () => startPuzzle(c));
    li.style.justifyContent = 'center';
    li.appendChild(resetBtn);
    foundList.appendChild(li);

    availableList.innerHTML = '';
    for (const c of CONSTELLATIONS) {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.textContent = 'Starten';
        /*btn.addEventListener('click', () => {
        active = c;
        edgeIdx = 0;
        progress = [0];
        activeNameEl.textContent = c.display;
        drawProgress();
      });*/
      btn.addEventListener('click', () => startPuzzle(c));
      li.innerHTML = `<span>${found.has(c.id) ? '‚≠ê' : ''} ${c.display}</span>`;
      li.appendChild(btn);
      availableList.appendChild(li);
    }
  }

  function nearPoint(mx, my) {
    const w = overlay.width, h = overlay.height;
    const pts = active.points.map(([x, y]) => ({x: x * w, y: y * h}));
    const r = 14 * DPR;
    for (let i = 0; i < pts.length; i++) {
      const d = Math.hypot(mx - pts[i].x, my - pts[i].y);
      if (d <= r) return i;
    }
    return -1;
  }

  function handleClick(ev) {
    if (!active) return;
    const rect = overlay.getBoundingClientRect();
    const mx = (ev.clientX - rect.left) * DPR;
    const my = (ev.clientY - rect.top) * DPR;
    const hit = nearPoint(mx, my);
    if (hit < 0) return toast('Tipp: die helleren Punkte anklicken.');

    const last = progress.length ? progress[progress.length - 1] : null;
    let curr = active.edges[edgeIdx];
    if (!curr) return;
    let expect; // = (last === null) ? 0 : (active.edges.find(e => e[0] === last) || [null, null])[1];
    if (last === null) {
      expect = curr[0];
    } else if (last === curr[0]) {
      expect = curr[1];
    } else if (last === curr[1]) {
      expect = active.edges[edgeIdx + 1]?.[0] ?? null;
    } else {
      expect = curr[0];
    }
    if (hit === expect) {

      progress.push(hit);
      drawProgress();
      if (curr && hit === curr[1]) edgeIdx++;
      const finished = edgeIdx === active.edges.length;
      if (finished) {
        confetti();
        answerInput.focus();
      }

    } else {
      toast('Upsi ‚Äì Reihenfolge beachten üòâ');
    }
  }

  function normalizeName(s) {
    return s.toLowerCase().trim().replaceAll('√§', 'ae').replaceAll('√∂', 'oe').replaceAll('√º', 'ue').replaceAll('√ü', 'ss');
  }

  function checkAnswer(name) {
    const n = normalizeName(name);
    const ok = n === normalizeName(active.display) || active.aliases.some(a => normalizeName(a) === n);
    if(DEBUG) {
      edgeIdx = 0;
      progress = [0];
      drawProgress();
      toast('Debug: Richtige L√∂sung - Fortschritt zur√ºckgesetzt.');
    } else {
      found.add(active.id);
      saveFound();
      rebuildLists();
      showFortune();
        pickNew();
    }
    return ok;
  }

  function showFortune() {
    const dlg = document.getElementById('fortuneModal');
    const text = document.getElementById('fortuneText');
    text.textContent = FORTUNES[Math.floor(Math.random() * FORTUNES.length)];
    dlg.showModal();
  }

  function confetti() {
    const emojis = ['‚ú®', 'üåü', 'üí´', '‚≠ê', 'üå†', 'üü°', 'üü£', 'üîµ'];
    for (let i = 0; i < 500; i++) {
      const span = document.createElement('div');
      span.className = 'confetti';
      span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      span.style.left = Math.random() * 100 + 'vw';
      span.style.animationDelay = (Math.random() * 0.5) + 's';
      document.body.appendChild(span);
      setTimeout(() => span.remove(), 2500);
    }
  }

  function toast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => {
      t.remove();
    }, 1600);
  }

  // Long-press screenshot (PNG)
  let pressTimer = null;
  skyWrap.addEventListener('pointerdown', () => {
    pressTimer = setTimeout(() => savePNG(), 700)
  });
  window.addEventListener('pointerup', () => {
    clearTimeout(pressTimer)
  });

  function savePNG() {
    // Merge background + overlay into one image
    const out = document.createElement('canvas');
    out.width = sky.width;
    out.height = sky.height;
    const ict = out.getContext('2d');
    ict.drawImage(sky, 0, 0);
    ict.drawImage(overlay, 0, 0);
    const link = document.createElement('a');
    link.download = 'sternenraetsel.png';
    link.href = out.toDataURL('image/png');
    link.click();
    toast('Screenshot gespeichert!');
  }

  // --- Events ----------------------------------------------------------
  overlay.addEventListener('click', handleClick);
  btnNew.addEventListener('click', pickNew);
  btnHints.addEventListener('click', () => {
    showHints = !showHints;
    drawProgress();
  });

  answerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const ok = checkAnswer(answerInput.value);
    if (!ok) {
      toast('Fast! Tipp: deutsch oder lateinisch eingeben.');
    }
    answerInput.value = '';
  });

  // Init
  resize();
  rebuildLists();
  pickNew();

  let lastDPR = getDPR();
  // subtle animation
  (function loop() {
    const nowDPR = getDPR();
    if (nowDPR !== lastDPR) {
      lastDPR = nowDPR;
      resize();
    }
    drawBackground();
    drawStars();
    drawProgress();
    requestAnimationFrame(loop);
  })();
</script>
</body>
</html>
